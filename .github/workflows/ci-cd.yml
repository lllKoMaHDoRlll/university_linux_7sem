name: CI-CD

on:
  push:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
      env:
        POSTGRES_USER: testuser
        POSTGRES_PASSWORD: testpass
        POSTGRES_DB: testdb
      ports:
        - 5432:5432
      options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Create .env file for testing
      working-directory: ./docker
      run: |
        cat > .env << EOF
        DATABASE_URL=postgresql://testuser:testpass@postgres:5432/testdb
        EOF

    - name: Set up Docker Buildx
    - uses: docker/setup-buildx-action@v2

    - name: Build test image
      working-directory: ./docker
      run: docker compose build test

    - name: Run tests
      working-directory: ./docker
      run: docker compose run --rm test
